<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave Application - PCCOE</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="https://img.icons8.com/color/96/000000/leave.png">
    <!-- jsPDF + html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 30px;
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            border-left: 6px solid #ff9800;
            border-right: 6px solid #ff9800;
            min-height: 110px;
        }

        .logo-left {
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }

        .college-logo {
            height: 95px;
            width: auto;
            object-fit: contain;
            padding: 6px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 6px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        .college-info {
            flex: 1;
            text-align: center;
            padding: 0 25px;
        }

        .college-info h1 {
            font-size: 18px;
            margin-bottom: 3px;
            font-weight: 500;
            color: #ffffff;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }

        .college-info h2 {
            font-size: 24px;
            margin-top: 3px;
            margin-bottom: 3px;
            font-weight: 700;
            color: white !important;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
            letter-spacing: 0.5px;
        }

        .college-info p {
            font-size: 16px;
            margin-top: 3px;
            font-weight: 500;
            color: #f0f0f0;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }

        .academic-year {
            font-size: 22px;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.95) 0%, rgba(255, 167, 38, 0.95) 100%);
            color: #1a237e;
            padding: 10px 20px;
            border-radius: 25px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
            text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
        }

        .form-container {
            padding: 30px 40px;
        }

        .form-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e8eaf6;
        }

        .form-header h1 {
            color: #1a237e;
            font-size: 2.2rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            display: none;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .status-message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
            display: block;
        }

        .status-message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
            display: block;
        }

        .status-message.info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
            display: block;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .form-section:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .form-section h3 {
            color: #3949ab;
            font-size: 1.5rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #444;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: 'Poppins', sans-serif;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3949ab;
            box-shadow: 0 0 0 3px rgba(57, 73, 171, 0.1);
        }

        .form-group input[readonly] {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .email-hint {
            color: #666;
            font-size: 0.85rem;
            margin-top: 5px;
            display: block;
        }

        .error-message {
            color: #c62828;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .input-error {
            border-color: #c62828 !important;
            background-color: #ffebee !important;
        }

        .input-success {
            border-color: #2e7d32 !important;
        }

        .days-counter {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .total-days-display {
            font-weight: bold;
            font-size: 1.1rem;
            color: #1a237e;
        }

        .leaves-info {
            background: #e8eaf6;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
        }

        .leaves-info i {
            color: #3949ab;
        }

        .history-table {
            margin-top: 20px;
            overflow-x: auto;
            display: none;
        }

        .history-table table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .history-table th {
            background: #3949ab;
            color: white;
            padding: 12px;
            font-weight: 500;
        }

        .history-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
        }

        .history-table tr:last-child td {
            border-bottom: none;
        }

        .history-table tr:hover {
            background: #f5f5f5;
        }

        .form-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
            flex-wrap: wrap;
        }

        .btn-primary,
        .btn-secondary,
        .btn-outline {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3949ab 0%, #283593 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(57, 73, 171, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #26a69a 0%, #00796b 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(38, 166, 154, 0.3);
        }

        .btn-outline {
            background: white;
            color: #3949ab;
            border: 2px solid #3949ab;
        }

        .btn-outline:hover {
            background: #f0f4ff;
            transform: translateY(-3px);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 15px 15px 0 0;
        }

        .modal-header h2 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-footer {
            padding: 20px 30px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            border-radius: 0 0 15px 15px;
        }

        .footer {
            background: #1a237e;
            color: white;
            text-align: center;
            padding: 25px;
            margin-top: 40px;
        }

        .footer p {
            margin-bottom: 10px;
        }

        .contact-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            font-size: 0.95rem;
        }

        .contact-info i {
            color: #ffd700;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3949ab;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 992px) {
            .header {
                padding: 15px 20px;
                min-height: 100px;
            }
            .college-logo {
                height: 80px;
            }
            .college-info h1 {
                font-size: 16px;
            }
            .college-info h2 {
                font-size: 20px;
            }
            .college-info p {
                font-size: 14px;
            }
            .academic-year {
                font-size: 18px;
                padding: 8px 16px;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                padding: 15px;
                min-height: auto;
            }
            .logo-left {
                margin-bottom: 10px;
            }
            .college-logo {
                height: 75px;
                margin-bottom: 5px;
            }
            .college-info {
                padding: 10px 0;
                margin-bottom: 10px;
            }
            .college-info h1 {
                font-size: 15px;
            }
            .college-info h2 {
                font-size: 18px;
            }
            .college-info p {
                font-size: 13px;
            }
            .academic-year {
                font-size: 17px;
                padding: 8px 15px;
                margin-top: 5px;
            }
            .form-container {
                padding: 20px;
            }
            .form-grid {
                grid-template-columns: 1fr;
            }
            .form-actions {
                flex-direction: column;
            }
            .btn-primary,
            .btn-secondary,
            .btn-outline {
                min-width: 100%;
            }
        }

        @media (max-width: 480px) {
            .college-info h1 {
                font-size: 14px;
            }
            .college-info h2 {
                font-size: 16px;
            }
            .college-info p {
                font-size: 12px;
            }
            .academic-year {
                font-size: 16px;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo-left">
                <img src="pccoe_logo.png" alt="PCCOE Logo" class="college-logo">
            </div>
            <div class="college-info">
                <h1>Pimpri Chinchwad Education Trust's</h1>
                <h2>Pimpri Chinchwad College of Engineering</h2>
                <p>Department of Applied Sciences & Humanities</p>
            </div>
            <div class="academic-year">
                <span>2025-26</span>
            </div>
        </header>

        <div class="form-container">
            <div class="form-header">
                <h1><i class="fas fa-file-alt"></i> Leave Application Form</h1>
                <p class="subtitle">Fill all details accurately. Leave will be processed by your Class Teacher.</p>
            </div>

            <div id="status-message" class="status-message"></div>

            <form id="leaveForm" class="leave-form">
                <div class="form-section">
                    <h3><i class="fas fa-user-graduate"></i> Student Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="academicYear">Academic Year *</label>
                            <select id="academicYear" name="academicYear" required>
                                <option value="">Select Academic Year</option>
                                <option value="2025-2026" selected>2025-2026</option>
                                <option value="2026-2027">2026-2027</option>
                                <option value="2027-2028">2027-2028</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="semester">Semester *</label>
                            <select id="semester" name="semester" required>
                                <option value="">Select Semester</option>
                                <option value="I">I</option>
                                <option value="II">II</option>
                                <option value="III">III</option>
                                <option value="IV">IV</option>
                                <option value="V">V</option>
                                <option value="VI">VI</option>
                                <option value="VII">VII</option>
                                <option value="VIII">VIII</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="prn">PRN Number *</label>
                            <input type="text" id="prn" name="prn" 
                                   pattern="[0-9]{3}[A-Z]{1}[0-9]{1}[A-Z]{1}[0-9]{3}" 
                                   placeholder="e.g 124B1F048" required 
                                   oninput="this.value = this.value.toUpperCase()">
                            <small>Format: 9 characters (e.g., 124B1F048)</small>
                            <span class="error-message" id="prnError"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="fullName">Full Name *</label>
                            <input type="text" id="fullName" name="fullName" 
                                   placeholder="Enter your full name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="division">Division *</label>
                            <select id="division" name="division" required>
                                <option value="">Select Division</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="G">G</option>
                                <option value="H">H</option>
                                <option value="I">I</option>
                                <option value="J">J</option>
                                <option value="K">K</option>
                                <option value="L">L</option>
                                <option value="M">M</option>
                                <option value="N">N</option>
                                <option value="O">O</option>
                                <option value="P">P</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="branch">Branch *</label>
                            <select id="branch" name="branch" required>
                                <option value="">Select Branch</option>
                                <option value="Computer">Computer</option>
                                <option value="Information Technology">Information Technology</option>
                                <option value="Mechanical">Mechanical</option>
                                <option value="Civil">Civil</option>
                                <option value="Electronics and Telecommunication">Electronics and Telecommunication</option>
                                <option value="Computer Regional">Computer Regional</option>
                                <option value="AI ML">AI ML</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="email">Email ID *</label>
                            <input type="email" id="email" name="email" 
                                   placeholder="studentname@pccoepune.org" 
                                   required>
                            <small class="email-hint">Only @pccoepune.org email ID allowed</small>
                            <span class="error-message" id="emailError"></span>
                        </div>
                        
                        <div class="form-group">
                            <label for="contact">Contact Number *</label>
                            <input type="tel" id="contact" name="contact" 
                                   pattern="[0-9]{10}" placeholder="10-digit mobile number" required>
                            <span class="error-message" id="contactError"></span>
                        </div>
                    </div>
                    
                    <!-- Leave history and total count display -->
                    <div class="leaves-info" id="leavesInfo" style="display: none;">
                        <i class="fas fa-history"></i>
                        <span id="leavesCount">0</span> total leave(s) taken previously
                    </div>
                    
                    <div class="history-table" id="historyContainer">
                        <h4><i class="fas fa-list-alt"></i> Previous Leave Applications</h4>
                        <table>
                            <thead>
                                <tr>
                                    <th>From Date</th>
                                    <th>To Date</th>
                                    <th>Leave Type</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-chalkboard-teacher"></i> Teacher Information</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="classTeacher">Class Teacher *</label>
                            <select id="classTeacher" name="classTeacher" required>
                                <option value="">Select Class Teacher</option>
                                <option value="Prof. Sanjay Mapari (Div A)">Prof. Sanjay Mapari (Div A)</option>
                                <option value="Prof. Arun Khalkar (Div B)">Prof. Arun Khalkar (Div B)</option>
                                <option value="Prof. Minakshi Panchal (Div C)">Prof. Minakshi Panchal (Div C)</option>
                                <option value="Prof. Dinesh Kute (Div O)">Prof. Dinesh Kute (Div O)</option>
                                <option value="Prof. Geetanjali Zambre (Div P)">Prof. Geetanjali Zambre (Div P)</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="associateTeacher">Associate Class Teacher</label>
                            <select id="associateTeacher" name="associateTeacher">
                                <option value="">Select Associate Teacher</option>
                                <option value="Prof. Brijesh Deshmukh (Div A)">Prof. Brijesh Deshmukh (Div A)</option>
                                <option value="Prof. Bhausaheb Sanap (Div B)">Prof. Bhausaheb Sanap (Div B)</option>
                                <option value="Prof. Dattatraya Anarse (Div C)">Prof. Dattatraya Anarse (Div C)</option>
                                <option value="Prof. Pooja Potdar (Div O)">Prof. Pooja Potdar (Div O)</option>
                                <option value="Prof. Ganesh Mundhe (Div P)">Prof. Ganesh Mundhe (Div P)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-calendar-alt"></i> Leave Details</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="leaveType">Type of Leave *</label>
                            <select id="leaveType" name="leaveType" required>
                                <option value="">Select Leave Type</option>
                                <option value="Medical Leave">Medical Leave</option>
                                <option value="Personal Leave">Personal Leave</option>
                                <option value="Family Emergency">Family Emergency</option>
                                <option value="Academic Leave">Academic Leave</option>
                                <option value="Event Participation">Event Participation</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="fromDate">From Date *</label>
                            <input type="date" id="fromDate" name="fromDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="toDate">To Date *</label>
                            <input type="date" id="toDate" name="toDate" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="totalDays">Total Number of Days</label>
                            <input type="text" id="totalDays" name="totalDays" readonly 
                                   value="0 days" class="total-days-display">
                            <div class="days-counter">
                                <span id="workingDays">Working days: 0</span>
                                <span id="totalDaysCount">Total days: 0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="reason">Reason for Leave *</label>
                        <textarea id="reason" name="reason" rows="4" 
                                  placeholder="Please provide detailed reason for leave..." required></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" id="previewBtn" class="btn-secondary">
                        <i class="fas fa-eye"></i> Preview Application
                    </button>
                    <button type="submit" id="submitBtn" class="btn-primary">
                        <i class="fas fa-paper-plane"></i> Submit Leave Application
                    </button>
                    <button type="reset" id="resetBtn" class="btn-outline">
                        <i class="fas fa-redo"></i> Clear Form
                    </button>
                </div>
            </form>

            <div id="previewModal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2><i class="fas fa-file-pdf"></i> Leave Application Preview</h2>
                        <button class="close-modal">&times;</button>
                    </div>
                    <div class="modal-body" id="previewContent"></div>
                    <div class="modal-footer">
                        <button id="printPreview" class="btn-secondary">
                            <i class="fas fa-print"></i> Print Preview
                        </button>
                        <button id="downloadPDF" class="btn-primary">
                            <i class="fas fa-download"></i> Download as PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>© 2025-26 PCCOE Leave Management System Prepared by Mr. Dinesh Kute</p>
            <p class="contact-info">
                <i class="fas fa-envelope"></i> dinesh.kute@pccoepune.org
            </p> 
        </footer>
    </div>

    <script>
        // === Configuration ===
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwHTXhvJHBo1_j9wz-gtnLNChQh5BW6P58715Eg5MUnuBM8dFjtkg8xy7pUBvv2QO6A/exec'; // Replace with your deployed URL

        const TEACHER_EMAILS = {
            'Prof. Sanjay Mapari (Div A)': 'sanjay.mapari@pccoepune.org',
            'Prof. Arun Khalkar (Div B)': 'arun.khalkar@pccoepune.org',
            'Prof. Minakshi Panchal (Div C)': 'minakshi.panchal@pccoepune.org',
            'Prof. Dinesh Kute (Div O)': 'dinesh.kute@pccoepune.org',
            'Prof. Geetanjali Zambre (Div P)': 'geetanjali.zambre@pccoepune.org',
            'Prof. Brijesh Deshmukh (Div A)': 'brijesh.deshmukh@pccoepune.org',
            'Prof. Bhausaheb Sanap (Div B)': 'bhausaheb.sanap@pccoepune.org',
            'Prof. Dattatraya Anarse (Div C)': 'dattatraya.anarse@pccoepune.org',
            'Prof. Pooja Potdar (Div O)': 'pooja.potdar@pccoepune.org',
            'Prof. Ganesh Mundhe (Div P)': 'ganesh.mundhe@pccoepune.org'
        };

        // DOM elements
        let leaveForm, fromDateInput, toDateInput, totalDaysDisplay, workingDaysSpan, totalDaysSpan;
        let submitBtn, previewBtn, previewModal, closeModal, previewContent, statusMessage;
        let prnInput, leavesInfo, leavesCountSpan, historyContainer, historyTableBody;

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            initializeElements();
            setupEventListeners();
            setupCurrentYear();
        });

        function initializeElements() {
            leaveForm = document.getElementById('leaveForm');
            fromDateInput = document.getElementById('fromDate');
            toDateInput = document.getElementById('toDate');
            totalDaysDisplay = document.getElementById('totalDays');
            workingDaysSpan = document.getElementById('workingDays');
            totalDaysSpan = document.getElementById('totalDaysCount');
            submitBtn = document.getElementById('submitBtn');
            previewBtn = document.getElementById('previewBtn');
            previewModal = document.getElementById('previewModal');
            closeModal = document.querySelector('.close-modal');
            previewContent = document.getElementById('previewContent');
            statusMessage = document.getElementById('status-message');
            prnInput = document.getElementById('prn');
            leavesInfo = document.getElementById('leavesInfo');
            leavesCountSpan = document.getElementById('leavesCount');
            historyContainer = document.getElementById('historyContainer');
            historyTableBody = document.getElementById('historyTableBody');
        }

        function setupEventListeners() {
            if (fromDateInput) fromDateInput.addEventListener('change', updateDateMin);
            if (toDateInput) toDateInput.addEventListener('change', calculateTotalDays);
            if (previewBtn) previewBtn.addEventListener('click', showPreview);
            if (leaveForm) leaveForm.addEventListener('submit', handleFormSubmit);
            if (closeModal) closeModal.addEventListener('click', () => {
                if (previewModal) previewModal.style.display = 'none';
            });
            window.addEventListener('click', (e) => {
                if (e.target === previewModal) previewModal.style.display = 'none';
            });

            const printBtn = document.getElementById('printPreview');
            const downloadBtn = document.getElementById('downloadPDF');
            if (printBtn) printBtn.addEventListener('click', printPreview);
            if (downloadBtn) downloadBtn.addEventListener('click', downloadAsPDF);

            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) resetBtn.addEventListener('click', resetForm);

            // Field validations
            const emailField = document.getElementById('email');
            const contactField = document.getElementById('contact');
            if (emailField) {
                emailField.addEventListener('input', validateEmail);
                emailField.addEventListener('blur', validateEmail);
            }
            if (prnInput) {
                prnInput.addEventListener('input', validatePRN);
                prnInput.addEventListener('blur', function() {
                    validatePRN();
                    const prn = prnInput.value.trim().toUpperCase();
                    if (prn.length >= 9) {
                        fetchStudentLeaveHistory(prn);
                    } else {
                        hideHistory();
                    }
                });
            }
            if (contactField) {
                contactField.addEventListener('input', validateContact);
                contactField.addEventListener('blur', validateContact);
            }
        }

        function setupCurrentYear() {
            const academicYearSelect = document.getElementById('academicYear');
            if (academicYearSelect) academicYearSelect.value = '2025-2026';
        }

        function updateDateMin() {
            if (!fromDateInput || !toDateInput) return;
            toDateInput.min = fromDateInput.value;
            if (toDateInput.value && new Date(toDateInput.value) < new Date(fromDateInput.value)) {
                toDateInput.value = fromDateInput.value;
            }
            calculateTotalDays();
        }

        function calculateTotalDays() {
            if (!fromDateInput || !toDateInput || !totalDaysDisplay || !workingDaysSpan || !totalDaysSpan) return;
            
            const fromDate = new Date(fromDateInput.value);
            const toDate = new Date(toDateInput.value);
            
            if (fromDateInput.value && toDateInput.value && fromDate <= toDate) {
                const timeDiff = toDate.getTime() - fromDate.getTime();
                const totalDays = Math.ceil(timeDiff / (1000 * 3600 * 24)) + 1;
                
                let workingDays = 0;
                let currentDate = new Date(fromDate);
                for (let i = 0; i < totalDays; i++) {
                    const dayOfWeek = currentDate.getDay();
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) workingDays++;
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                totalDaysDisplay.value = `${totalDays} day${totalDays !== 1 ? 's' : ''}`;
                workingDaysSpan.textContent = `Working days: ${workingDays}`;
                totalDaysSpan.textContent = `Total days: ${totalDays}`;
                
                return { totalDays, workingDays };
            } else {
                totalDaysDisplay.value = '0 days';
                workingDaysSpan.textContent = 'Working days: 0';
                totalDaysSpan.textContent = 'Total days: 0';
                return { totalDays: 0, workingDays: 0 };
            }
        }

        function validateEmail() {
            const emailField = document.getElementById('email');
            const emailError = document.getElementById('emailError');
            if (!emailField || !emailError) return;
            
            const email = emailField.value.trim();
            const pccoeDomainRegex = /^[a-zA-Z0-9._%+-]+@pccoepune\.org$/i;
            
            emailField.classList.remove('input-error', 'input-success');
            emailError.textContent = '';
            emailError.style.display = 'none';
            
            if (!email) {
                emailField.classList.add('input-error');
                emailError.textContent = 'Email is required';
                emailError.style.display = 'block';
                return false;
            }
            
            if (!pccoeDomainRegex.test(email)) {
                emailField.classList.add('input-error');
                emailError.textContent = 'Only @pccoepune.org email addresses are allowed';
                emailError.style.display = 'block';
                return false;
            }
            
            emailField.classList.add('input-success');
            return true;
        }

        function validatePRN() {
            const prnField = document.getElementById('prn');
            const prnError = document.getElementById('prnError');
            if (!prnField || !prnError) return;
            
            const prn = prnField.value.trim().toUpperCase();
            const prnRegex = /^[0-9]{3}[A-Z]{1}[0-9]{1}[A-Z]{1}[0-9]{3}$/;
            
            prnField.classList.remove('input-error', 'input-success');
            prnError.textContent = '';
            prnError.style.display = 'none';
            
            if (!prn) {
                prnField.classList.add('input-error');
                prnError.textContent = 'PRN is required';
                prnError.style.display = 'block';
                return false;
            }
            
            if (!prnRegex.test(prn)) {
                prnField.classList.add('input-error');
                prnError.textContent = 'PRN must be 9 characters in format: 124B1F048';
                prnError.style.display = 'block';
                return false;
            }
            
            prnField.classList.add('input-success');
            return true;
        }

        function validateContact() {
            const contactField = document.getElementById('contact');
            const contactError = document.getElementById('contactError');
            if (!contactField || !contactError) return;
            
            const contact = contactField.value.trim();
            const contactRegex = /^[0-9]{10}$/;
            
            contactField.classList.remove('input-error', 'input-success');
            contactError.textContent = '';
            contactError.style.display = 'none';
            
            if (!contact) {
                contactField.classList.add('input-error');
                contactError.textContent = 'Contact number is required';
                contactError.style.display = 'block';
                return false;
            }
            
            if (!contactRegex.test(contact)) {
                contactField.classList.add('input-error');
                contactError.textContent = 'Contact must be exactly 10 digits';
                contactError.style.display = 'block';
                return false;
            }
            
            contactField.classList.add('input-success');
            return true;
        }

        function validateAllFields() {
            return validateEmail() && validatePRN() && validateContact();
        }

        // === Fetch student's previous leaves (history) from spreadsheet ===
        async function fetchStudentLeaveHistory(prn) {
            if (!prn || prn.length < 9) {
                hideHistory();
                return;
            }
            try {
                const url = `${SCRIPT_URL}?action=getHistory&prn=${encodeURIComponent(prn)}`;
                const response = await fetch(url);
                const data = await response.json();
                if (data.success && Array.isArray(data.leaves)) {
                    displayLeaveHistory(data.leaves);
                    // Update total count display
                    leavesCountSpan.textContent = data.total;
                    leavesInfo.style.display = 'flex';
                } else {
                    hideHistory();
                }
            } catch (error) {
                console.error('Error fetching leave history:', error);
                hideHistory();
            }
        }

        function displayLeaveHistory(leaves) {
            historyTableBody.innerHTML = ''; // clear previous
            if (leaves.length === 0) {
                hideHistory();
                return;
            }

            leaves.forEach(leave => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${leave.fromDate || ''}</td>
                    <td>${leave.toDate || ''}</td>
                    <td>${leave.leaveType || ''}</td>
                    <td>${leave.status || 'Pending'}</td>
                `;
                historyTableBody.appendChild(row);
            });

            historyContainer.style.display = 'block';
        }

        function hideHistory() {
            historyContainer.style.display = 'none';
            leavesInfo.style.display = 'none';
        }

        // === Preview generation (same as before) ===
        function generatePreviewHTML(formData) {
            const days = calculateTotalDays();
            const currentDate = new Date().toLocaleDateString('en-US', {
                year: 'numeric', month: '2-digit', day: '2-digit'
            });
            const classTeacherFull = formData.get('classTeacher') || '';
            const classTeacherName = classTeacherFull.split(' (')[0] || classTeacherFull;
            const studentName = formData.get('fullName') || '';
            
            return `
                <div class="preview-document">
                    <div class="preview-college-header" style="text-align: center; margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #1a237e 0%, #283593 100%); color: white; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15); border-left: 6px solid #ff9800; border-right: 6px solid #ff9800;">
                        <h1 style="font-size: 18px; margin-bottom: 3px; font-weight: 500; color: #ffffff;">Pimpri Chinchwad Education Trust's</h1>
                        <h2 style="font-size: 24px; margin-top: 3px; margin-bottom: 3px; font-weight: 700; color: white;">Pimpri Chinchwad College of Engineering</h2>
                        <p style="font-size: 16px; margin-top: 3px; font-weight: 500; color: #f0f0f0;">Department of Applied Sciences & Humanities</p>
                        <div style="margin-top: 15px; font-size: 22px; font-weight: 700; background: linear-gradient(135deg, rgba(255, 152, 0, 0.95) 0%, rgba(255, 167, 38, 0.95) 100%); color: #1a237e; padding: 10px 20px; border-radius: 25px; border: 2px solid rgba(255, 255, 255, 0.4); box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2); display: inline-block;">
                            2025–26
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid #e8eaf6;">
                        <h1 style="color: #1a237e; font-size: 2.2rem; margin-bottom: 10px;">
                            <i class="fas fa-file-alt"></i> Leave Application Form
                        </h1>
                        <p style="color: #666; font-size: 1.1rem;">
                            Fill all details accurately. Leave will be processed by your Class Teacher.
                        </p>
                    </div>
                    
                    <div style="text-align: right; margin-bottom: 20px; color: #666; font-size: 0.9rem;">
                        Generated on: ${currentDate}
                    </div>
                    
                    <div class="preview-section" style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 1px solid #e0e0e0;">
                        <h3 style="color: #3949ab; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 15px;">
                            <i class="fas fa-user-graduate"></i> Student Information
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                            <div><strong>Academic Year:</strong> ${formData.get('academicYear')}</div>
                            <div><strong>Semester:</strong> ${formData.get('semester')}</div>
                            <div><strong>PRN:</strong> ${formData.get('prn')}</div>
                            <div><strong>Full Name:</strong> ${studentName}</div>
                            <div><strong>Division:</strong> ${formData.get('division')}</div>
                            <div><strong>Branch:</strong> ${formData.get('branch')}</div>
                            <div><strong>Email:</strong> ${formData.get('email')}</div>
                            <div><strong>Contact:</strong> ${formData.get('contact')}</div>
                        </div>
                    </div>
                    
                    <div class="preview-section" style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 1px solid #e0e0e0;">
                        <h3 style="color: #3949ab; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 15px;">
                            <i class="fas fa-chalkboard-teacher"></i> Teacher Information
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                            <div><strong>Class Teacher:</strong> ${formData.get('classTeacher')}</div>
                            <div><strong>Associate Teacher:</strong> ${formData.get('associateTeacher') || 'N/A'}</div>
                        </div>
                    </div>
                    
                    <div class="preview-section" style="margin-bottom: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 1px solid #e0e0e0;">
                        <h3 style="color: #3949ab; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px; margin-bottom: 15px;">
                            <i class="fas fa-calendar-alt"></i> Leave Details
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 15px;">
                            <div><strong>Leave Type:</strong> ${formData.get('leaveType')}</div>
                            <div><strong>From Date:</strong> ${formData.get('fromDate')}</div>
                            <div><strong>To Date:</strong> ${formData.get('toDate')}</div>
                            <div><strong>Total Days:</strong> ${days.totalDays} (${days.workingDays} working days)</div>
                        </div>
                        <div style="margin-top: 15px;">
                            <strong>Reason:</strong>
                            <p style="background: #f5f5f5; padding: 15px; border-radius: 5px; margin-top: 5px; white-space: pre-wrap;">
                                ${formData.get('reason')}
                            </p>
                        </div>
                    </div>
                    
                    <div class="preview-footer" style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div style="flex: 1;">
                                <p><strong>Student Signature:</strong></p>
                                <div style="margin-top: 60px; border-top: 1px solid #000; width: 200px; padding-top: 5px; text-align: center;">
                                    ${studentName}
                                </div>
                                <p style="margin-top: 30px;"><strong>Date:</strong> ${currentDate}</p>
                            </div>
                            <div style="flex: 1; text-align: right;">
                                <p><strong>Class Teacher Signature:</strong></p>
                                <div style="margin-top: 60px; border-top: 1px solid #000; width: 200px; margin-left: auto; padding-top: 5px; text-align: center;">
                                    ${classTeacherName}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showPreview() {
            if (!leaveForm || !leaveForm.checkValidity()) {
                showMessage('Please fill all required fields correctly', 'error');
                leaveForm.reportValidity();
                return;
            }
            if (!validateAllFields()) {
                showMessage('Please correct the highlighted fields', 'error');
                return;
            }
            const formData = new FormData(leaveForm);
            previewContent.innerHTML = generatePreviewHTML(formData);
            previewModal.style.display = 'flex';
        }

        // === Form submission ===
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!leaveForm.checkValidity()) {
                showMessage('Please fill all required fields correctly', 'error');
                leaveForm.reportValidity();
                return;
            }
            if (!validateAllFields()) {
                showMessage('Please correct the highlighted fields before submitting', 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

            try {
                const formData = new FormData(leaveForm);
                const days = calculateTotalDays();
                const classTeacher = formData.get('classTeacher');
                const associateTeacher = formData.get('associateTeacher') || '';

                const rowData = {
                    timestamp: new Date().toISOString(),
                    academicYear: formData.get('academicYear'),
                    semester: formData.get('semester'),
                    prn: formData.get('prn'),
                    fullName: formData.get('fullName'),
                    division: formData.get('division'),
                    branch: formData.get('branch'),
                    email: formData.get('email'),
                    contact: formData.get('contact'),
                    classTeacher: classTeacher,
                    classTeacherEmail: TEACHER_EMAILS[classTeacher] || '',
                    associateTeacher: associateTeacher,
                    associateTeacherEmail: associateTeacher ? (TEACHER_EMAILS[associateTeacher] || '') : '',
                    leaveType: formData.get('leaveType'),
                    fromDate: formData.get('fromDate'),
                    toDate: formData.get('toDate'),
                    totalDays: days.totalDays,
                    workingDays: days.workingDays,
                    reason: formData.get('reason'),
                    status: 'Pending',
                    sendEmails: true
                };

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rowData)
                });

                showMessage('Leave application submitted successfully!', 'success');
                
                // Automatically download PDF after successful submission
                setTimeout(() => {
                    const previewHTML = generatePreviewHTML(formData);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = previewHTML;
                    document.body.appendChild(tempDiv);
                    html2canvas(tempDiv, { scale: 2 }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                        const imgWidth = 210;
                        const pageHeight = 297;
                        const imgHeight = (canvas.height * imgWidth) / canvas.width;
                        let heightLeft = imgHeight;
                        let position = 0;
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                        while (heightLeft > 0) {
                            position = heightLeft - imgHeight;
                            pdf.addPage();
                            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                            heightLeft -= pageHeight;
                        }
                        pdf.save(`Leave_Application_${formData.get('fullName') || 'Student'}.pdf`);
                    }).finally(() => {
                        tempDiv.remove();
                    });
                }, 500);

                resetForm();
                
                setTimeout(() => {
                    if (statusMessage) statusMessage.style.display = 'none';
                }, 5000);

            } catch (error) {
                console.error('Error:', error);
                showMessage('Error submitting form. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Leave Application';
            }
        }

        function printPreview() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Leave Application</title>
                        <style>
                            @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css');
                            @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
                            body { font-family: 'Poppins', sans-serif; padding: 20px; line-height: 1.6; }
                            .preview-section { margin-bottom: 30px; }
                            h3 { color: #1a237e; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
                            strong { color: #333; }
                            p { margin: 5px 0; }
                            .preview-college-header { text-align: center; margin-bottom: 30px; }
                            .preview-footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #e0e0e0; }
                        </style>
                    </head>
                    <body>
                        ${previewContent.innerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function downloadAsPDF() {
            const element = document.getElementById('previewContent');
            if (!element) {
                showMessage('Preview content not found', 'error');
                return;
            }
            showMessage('Generating PDF...', 'info');
            html2canvas(element, { scale: 2, useCORS: true, logging: false })
                .then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210;
                    const pageHeight = 297;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    while (heightLeft > 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    pdf.save(`Leave_Application_${document.getElementById('fullName').value || 'Student'}.pdf`);
                    showMessage('PDF downloaded successfully!', 'success');
                    setTimeout(() => { if (statusMessage) statusMessage.style.display = 'none'; }, 3000);
                })
                .catch(error => {
                    console.error('Error generating PDF:', error);
                    showMessage('Error generating PDF. Please try Print Preview instead.', 'error');
                });
        }

        function resetForm() {
            if (leaveForm) {
                leaveForm.reset();
                document.querySelectorAll('.input-error, .input-success').forEach(f => f.classList.remove('input-error', 'input-success'));
                document.querySelectorAll('.error-message').forEach(e => { e.textContent = ''; e.style.display = 'none'; });
            }
            clearLeaveDetails();
            setupCurrentYear();
            hideHistory();
            showMessage('Form has been reset', 'info');
            setTimeout(() => { if (statusMessage) statusMessage.style.display = 'none'; }, 3000);
        }

        function clearLeaveDetails() {
            const leaveTypeSelect = document.getElementById('leaveType');
            if (leaveTypeSelect) leaveTypeSelect.value = '';
            if (fromDateInput) fromDateInput.value = '';
            if (toDateInput) toDateInput.value = '';
            if (totalDaysDisplay) totalDaysDisplay.value = '0 days';
            if (workingDaysSpan) workingDaysSpan.textContent = 'Working days: 0';
            if (totalDaysSpan) totalDaysSpan.textContent = 'Total days: 0';
        }

        function showMessage(message, type = 'info') {
            if (!statusMessage) return;
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;
            statusMessage.style.display = 'block';
            if (type === 'success' || type === 'info') {
                setTimeout(() => { statusMessage.style.display = 'none'; }, 5000);
            }
        }

        // Input event to remove red border
        if (leaveForm) {
            leaveForm.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('invalid', function(e) {
                    e.preventDefault();
                    this.style.borderColor = '#c62828';
                });
                input.addEventListener('input', function() {
                    this.style.borderColor = '#ddd';
                });
            });
        }
    </script>
</body>
</html>
